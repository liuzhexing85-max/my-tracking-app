<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Logistics - Professional Tracking</title>
    
    <!-- APP ICON (ဒီနေရာမှာ ကားပုံလေး ထည့်ပေးထားပါတယ်) -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/411/411763.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/411/411763.png">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #0d2c56;
            --accent-color: #fca311;
            --bg-color: #f3f5f9;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Poppins', sans-serif; 
            color: #333;
        }

        /* NAVBAR */
        .navbar {
            background-color: var(--primary-color) !important;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .navbar-brand { font-weight: 700; letter-spacing: 1px; font-size: 1.5rem; }

        /* INPUT STYLING */
        .track-form-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .custom-input {
            background-color: #f8f9fa;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 15px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .custom-input:focus {
            background-color: #fff;
            border-color: var(--accent-color);
            box-shadow: none;
        }

        .btn-track {
            background-color: var(--accent-color);
            color: #fff;
            font-weight: bold;
            border-radius: 12px;
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            width: 100%;
            transition: transform 0.2s;
        }
        .btn-track:active { transform: scale(0.98); }

        /* RESULT AREA */
        .custom-card {
            background: #fff;
            border-radius: 16px;
            border: none;
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin-bottom: 20px;
        }

        .tracking-header {
            background: linear-gradient(135deg, #0d2c56 0%, #1a4b8c 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        /* TIMELINE */
        .timeline-container { position: relative; margin: 30px 0; padding-left: 20px; }
        .timeline-step {
            position: relative;
            padding-bottom: 30px;
            padding-left: 30px;
            border-left: 3px solid #e0e0e0;
        }
        .timeline-step:last-child { border-left: transparent; }
        .timeline-step::before {
            content: ''; position: absolute; left: -11px; top: 0;
            width: 20px; height: 20px; border-radius: 50%;
            background: #fff; border: 4px solid #e0e0e0; z-index: 2;
        }
        .timeline-step.active { border-left-color: #28a745; }
        .timeline-step.active::before { border-color: #28a745; background: #28a745; }
        .timeline-step.current::before { border-color: var(--accent-color); background: #fff; }

        .timeline-title { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .timeline-date { font-size: 0.8rem; color: #888; }

        .detail-label { font-size: 0.75rem; text-transform: uppercase; color: #888; letter-spacing: 0.5px; font-weight: 600; }
        .detail-value { font-size: 1rem; font-weight: 600; color: #0d2c56; margin-bottom: 15px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="bi bi-truck-flatbed"></i> GLOBAL LOGISTICS</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" onclick="showPage('home')">TRACK SHIPMENT</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('adminLogin')">ADMIN PORTAL</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="container mt-5 mb-5">

    <!-- 1. USER TRACKING PAGE -->
    <div id="homePage">
        <div class="row justify-content-center">
            <div class="col-md-6">
                
                <div class="text-center mb-4">
                    <h2 class="fw-bold" style="color: var(--primary-color);">Track Your Package</h2>
                    <p class="text-muted">Enter your Tracking ID & Verify Code</p>
                </div>

                <!-- TRACKING FORM -->
                <div class="track-form-container">
                    <div class="mb-2">
                        <label class="fw-bold small text-muted ms-1">TRACKING NUMBER</label>
                        <input type="text" id="trackInput" class="form-control custom-input" placeholder="e.g. DS-123456">
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold small text-muted ms-1">VERIFY CODE</label>
                        <input type="text" id="verifyInput" class="form-control custom-input" placeholder="e.g. MKL34">
                    </div>

                    <button class="btn-track shadow-sm" onclick="trackShipment()">TRACK NOW</button>

                    <!-- Error Message -->
                    <div id="errorMsg" class="alert alert-danger hidden mt-3 rounded-3 border-0 text-center">
                        <i class="bi bi-exclamation-circle-fill"></i> Tracking Number or Verify Code Incorrect!
                    </div>
                </div>

                <!-- LOADING -->
                <div id="loadingSpinner" class="text-center hidden mt-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Searching...</p>
                </div>

                <!-- RESULT CARD -->
                <div id="trackingResult" class="custom-card hidden mt-4">
                    
                    <div class="tracking-header">
                        <div class="text-uppercase small opacity-75">Tracking Number</div>
                        <div class="fs-3 fw-bold" id="resTrackNo">---</div>
                    </div>

                    <div class="text-center mb-4">
                        <span id="resStatusBadge" class="badge rounded-pill bg-success fs-6 px-4 py-2">---</span>
                    </div>

                    <div class="row g-4">
                        <!-- Sender Side -->
                        <div class="col-md-6 border-end">
                            <h6 class="text-primary fw-bold mb-3"><i class="bi bi-box-arrow-up"></i> SENDER</h6>
                            <div class="detail-label">Name</div>
                            <div class="detail-value" id="resSender">---</div>
                            <div class="detail-label">Location</div>
                            <div class="detail-value" id="resSenderLoc">---</div>
                            <div class="detail-label">Origin Country</div>
                            <div class="detail-value" id="resFromCountry">---</div>
                        </div>

                        <!-- Receiver Side -->
                        <div class="col-md-6 ps-md-4">
                            <h6 class="text-success fw-bold mb-3"><i class="bi bi-box-arrow-in-down"></i> RECEIVER</h6>
                            <div class="detail-label">Client Name</div>
                            <div class="detail-value" id="resClient">---</div>
                            <div class="detail-label">Phone No</div>
                            <div class="detail-value text-danger" id="resClientPhone">---</div>
                            <div class="detail-label">Location</div>
                            <div class="detail-value" id="resClientLoc">---</div>
                            <div class="detail-label">Destination</div>
                            <div class="detail-value" id="resToCountry">---</div>
                        </div>
                    </div>

                    <hr class="my-4">
                    <h6 class="fw-bold mb-3 text-secondary">SHIPMENT PROGRESS</h6>
                    <div class="timeline-container" id="timelineContainer"></div>

                </div>
            </div>
        </div>
    </div>

    <!-- 2. ADMIN LOGIN PAGE -->
    <div id="adminLoginPage" class="hidden">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="custom-card text-center">
                    <h4 class="fw-bold mb-4">Admin Portal</h4>
                    <div class="mb-3 text-start">
                        <input type="text" id="adminUser" class="form-control custom-input" placeholder="Username">
                    </div>
                    <div class="mb-4 text-start">
                        <input type="password" id="adminPass" class="form-control custom-input" placeholder="Password">
                    </div>
                    <button class="btn btn-primary w-100 btn-lg rounded-pill" onclick="login()">SECURE LOGIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ADMIN DASHBOARD -->
    <div id="adminDashboard" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold" style="color: var(--primary-color);">Dashboard</h3>
            <button class="btn btn-outline-danger rounded-pill px-4" onclick="logout()">Logout</button>
        </div>

        <div class="custom-card p-0 overflow-hidden">
            <div class="card-header bg-white border-bottom p-0">
                <ul class="nav nav-pills nav-fill p-3" id="myTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active fw-bold" id="create-tab" data-bs-toggle="tab" data-bs-target="#create">CREATE SHIPMENT</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link fw-bold" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage">MANAGE LIST</button>
                    </li>
                </ul>
            </div>

            <div class="card-body p-4">
                <div class="tab-content">
                    
                    <!-- CREATE TAB -->
                    <div class="tab-pane fade show active" id="create">
                        <div class="row g-4">
                            <!-- SENDER DETAILS -->
                            <div class="col-md-6">
                                <div class="p-4 bg-light rounded-3 h-100">
                                    <h6 class="text-primary fw-bold mb-3">SENDER DETAILS</h6>
                                    <div class="mb-3"><input type="text" id="senderName" class="form-control" placeholder="Sender Name"></div>
                                    <div class="mb-3"><input type="text" id="senderLoc" class="form-control" placeholder="City/Location"></div>
                                    <div class="mb-3">
                                        <select id="sendFromCountry" class="form-select">
                                            <option value="" disabled selected>Select Origin</option>
                                            <option value="Malaysia">Malaysia</option>
                                            <option value="Singapore">Singapore</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CLIENT DETAILS -->
                            <div class="col-md-6">
                                <div class="p-4 bg-light rounded-3 h-100">
                                    <h6 class="text-success fw-bold mb-3">CLIENT DETAILS</h6>
                                    <div class="mb-3"><input type="text" id="clientName" class="form-control" placeholder="Client Name"></div>
                                    <div class="mb-3"><input type="text" id="clientPhone" class="form-control" placeholder="Phone Number"></div>
                                    <div class="mb-3"><input type="text" id="clientLoc" class="form-control" placeholder="City/Location"></div>
                                    <div class="mb-3">
                                        <label class="small text-muted mb-1">Destination Country</label>
                                        <select id="sendToCountry" class="form-select" style="height: 50px;">
                                            <option value="" disabled selected>Select Destination</option>
                                            
                                            <optgroup label="Popular">
                                                <option value="Vietnam">Vietnam</option>
                                                <option value="Thailand">Thailand</option>
                                                <option value="Myanmar">Myanmar</option>
                                                <option value="Singapore">Singapore</option>
                                            </optgroup>

                                            <optgroup label="Asia / Oceania">
                                                <option value="Australia">Australia</option>
                                                <option value="Malaysia">Malaysia</option>
                                                <option value="Indonesia">Indonesia</option>
                                                <option value="Philippines">Philippines</option>
                                                <option value="Cambodia">Cambodia</option>
                                                <option value="Laos">Laos</option>
                                                <option value="China">China</option>
                                                <option value="Japan">Japan</option>
                                                <option value="South Korea">South Korea</option>
                                                <option value="Taiwan">Taiwan</option>
                                                <option value="Hong Kong">Hong Kong</option>
                                                <option value="India">India</option>
                                            </optgroup>
                                            
                                            <optgroup label="Europe">
                                                <option value="Austria">Austria</option>
                                                <option value="UK">UK</option>
                                                <option value="Germany">Germany</option>
                                                <option value="France">France</option>
                                                <option value="Italy">Italy</option>
                                                <option value="Spain">Spain</option>
                                                <option value="Netherlands">Netherlands</option>
                                                <option value="Switzerland">Switzerland</option>
                                            </optgroup>

                                            <optgroup label="Americas">
                                                <option value="USA">USA</option>
                                                <option value="Canada">Canada</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg px-5 rounded-pill shadow" onclick="createShipmentFirestore()">
                                GENERATE TRACKING & SAVE
                            </button>
                        </div>
                    </div>

                    <!-- MANAGE TAB -->
                    <div class="tab-pane fade" id="manage">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID / Code</th>
                                        <th>Client</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="shipmentTableBody">
                                    <tr><td colspan="4" class="text-center py-4">Loading data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- QR MODAL -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 p-3">
            <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <div class="display-1 text-success mb-3"><i class="bi bi-check-circle-fill"></i></div>
                <h4 class="fw-bold">Shipment Created!</h4>
                <div class="bg-light p-3 rounded mt-3 mb-3">
                    <div class="small text-muted">Tracking Number</div>
                    <div class="fs-4 fw-bold text-primary" id="modalTrackNo">---</div>
                    <hr>
                    <div class="small text-muted">Verify Code</div>
                    <div class="fs-3 fw-bold text-danger font-monospace" id="modalVerifyCode">---</div>
                </div>
                <p>Do you want to generate a QR Code?</p>
                <div id="qrResultArea" class="hidden mt-3">
                    <img id="generatedQrImg" src="" class="img-fluid border p-2 rounded shadow-sm" style="width: 180px;">
                </div>
                <div id="modalButtons" class="mt-4">
                    <button class="btn btn-light px-4" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary px-4" onclick="showQrInModal()">Generate QR</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // -------------------------------------------------------------------
    // --- FIREBASE CONFIG ---
    // -------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCDTIcr5F3D7xA0DR6TLnN3inEtcXJNSEQ",
      authDomain: "drop-shopping-99a05.firebaseapp.com",
      databaseURL: "https://drop-shopping-99a05-default-rtdb.firebaseio.com",
      projectId: "drop-shopping-99a05",
      storageBucket: "drop-shopping-99a05.firebasestorage.app",
      messagingSenderId: "838665485285",
      appId: "1:838665485285:web:2d131abfc7d556872e8d0c",
      measurementId: "G-FL3EFJGSLT"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const STATUS_STEPS = ["Arrived at custom", "In transit", "Arrived", "Out for delivery", "Delivered"];
    let latestTrackNo = ""; 

    // --- NAVIGATION ---
    function showPage(pageId) {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('adminLoginPage').classList.add('hidden');
        document.getElementById('adminDashboard').classList.add('hidden');
        
        const navBar = document.getElementById('navbarNav');
        if(navBar.classList.contains('show')) new bootstrap.Collapse(navBar).hide();

        if(pageId === 'home') document.getElementById('homePage').classList.remove('hidden');
        if(pageId === 'adminLogin') document.getElementById('adminLoginPage').classList.remove('hidden');
        if(pageId === 'dashboard') {
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadRealtimeShipments();
        }
    }

    // --- ADMIN LOGIC ---
    function login() {
        const u = document.getElementById('adminUser').value;
        const p = document.getElementById('adminPass').value;
        // lacus / lacus0000 (Case Sensitive)
        if(u === "lacus" && btoa(p) === "bGFjdXMwMDAw") {
            showPage('dashboard');
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
        } else {
            alert("Access Denied (Check username/password case)");
        }
    }
    function logout() { showPage('home'); }

    // --- CODE GENERATOR ---
    function generateVerifyCode() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; 
        let result = "";
        for (let i = 0; i < 5; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // --- FIREBASE: CREATE SHIPMENT ---
    function createShipmentFirestore() {
        const sName = document.getElementById('senderName').value;
        const sLoc = document.getElementById('senderLoc').value;
        const sCountry = document.getElementById('sendFromCountry').value;
        const cName = document.getElementById('clientName').value;
        const cPhone = document.getElementById('clientPhone').value;
        const cLoc = document.getElementById('clientLoc').value;
        const cCountry = document.getElementById('sendToCountry').value;

        if(!sName || !cName || !cPhone) { alert("Please fill in required fields."); return; }

        const trackNo = "DS-" + Math.floor(100000 + Math.random() * 900000);
        const verifyCode = generateVerifyCode(); // e.g. MKL34
        latestTrackNo = trackNo;

        db.collection("shipments").add({
            track_id: trackNo,
            verify_code: verifyCode,
            sender: sName,
            senderLoc: sLoc,
            fromCountry: sCountry,
            client: cName,
            clientPhone: cPhone,
            clientLoc: cLoc,
            toCountry: cCountry,
            status: "Arrived at custom",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            document.querySelectorAll('#create input').forEach(input => input.value = '');
            
            document.getElementById('modalTrackNo').innerText = trackNo;
            document.getElementById('modalVerifyCode').innerText = verifyCode;
            document.getElementById('qrResultArea').classList.add('hidden');
            document.getElementById('modalButtons').classList.remove('hidden');
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        })
        .catch(err => alert("Error: " + err.message));
    }

    function showQrInModal() {
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${latestTrackNo}`;
        document.getElementById('generatedQrImg').src = qrUrl;
        document.getElementById('qrResultArea').classList.remove('hidden');
        document.getElementById('modalButtons').classList.add('hidden');
    }

    // --- FIREBASE: MANAGE TABLE ---
    function loadRealtimeShipments() {
        db.collection("shipments").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            const tbody = document.getElementById('shipmentTableBody');
            tbody.innerHTML = '';
            
            if(snapshot.empty) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No records.</td></tr>'; return; }

            snapshot.forEach((doc) => {
                const item = doc.data();
                
                let statusOptions = '';
                STATUS_STEPS.forEach(step => {
                    const selected = item.status === step ? 'selected' : '';
                    statusOptions += `<option value="${step}" ${selected}>${step}</option>`;
                });

                const row = `
                    <tr>
                        <td>
                            <div class="fw-bold text-primary">${item.track_id}</div>
                            <small class="text-danger font-monospace bg-light px-1 border rounded">${item.verify_code}</small>
                        </td>
                        <td>${item.client}<br><small class="text-muted">${item.clientPhone}</small></td>
                        <td>
                            <select onchange="updateStatus('${doc.id}', this.value)" class="form-select form-select-sm border-0 bg-light fw-bold" style="width:140px;">
                                ${statusOptions}
                            </select>
                        </td>
                        <td><button class="btn btn-sm btn-light text-danger" onclick="deleteShipment('${doc.id}')"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        });
    }

    function updateStatus(docId, val) { db.collection("shipments").doc(docId).update({ status: val }); }
    function deleteShipment(docId) { if(confirm("Delete?")) db.collection("shipments").doc(docId).delete(); }

    // --- USER TRACKING ---
    function trackShipment() {
        const inputId = document.getElementById('trackInput').value.trim();
        const inputCode = document.getElementById('verifyInput').value.trim();
        
        const resDiv = document.getElementById('trackingResult');
        const errDiv = document.getElementById('errorMsg');
        const load = document.getElementById('loadingSpinner');

        if(!inputId || !inputCode) {
            alert("Please enter both Tracking Number and Verify Code");
            return;
        }
        
        resDiv.classList.add('hidden');
        errDiv.classList.add('hidden');
        load.classList.remove('hidden');

        db.collection("shipments").where("track_id", "==", inputId).get()
        .then((snapshot) => {
            load.classList.add('hidden');
            
            if(snapshot.empty) {
                errDiv.classList.remove('hidden');
                return;
            }

            const data = snapshot.docs[0].data();
            
            // Check Verify Code (Case Insensitive)
            if (data.verify_code.toUpperCase() === inputCode.toUpperCase()) {
                resDiv.classList.remove('hidden');

                document.getElementById('resTrackNo').innerText = data.track_id;
                document.getElementById('resStatusBadge').innerText = data.status;
                
                document.getElementById('resSender').innerText = data.sender;
                document.getElementById('resSenderLoc').innerText = data.senderLoc;
                document.getElementById('resFromCountry').innerText = data.fromCountry;
                
                document.getElementById('resClient').innerText = data.client;
                document.getElementById('resClientPhone').innerText = data.clientPhone || "N/A";
                document.getElementById('resClientLoc').innerText = data.clientLoc;
                document.getElementById('resToCountry').innerText = data.toCountry;

                renderTimeline(data.status);
            } else {
                errDiv.classList.remove('hidden');
            }
        })
        .catch(err => {
            load.classList.add('hidden');
            console.error(err);
            errDiv.classList.remove('hidden');
        });
    }

    // --- TIMELINE ---
    function renderTimeline(currentStatus) {
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';
        let isActive = true;
        
        STATUS_STEPS.forEach(step => {
            let cssClass = "timeline-step";
            if(isActive) cssClass += " active";
            if(step === currentStatus) {
                cssClass += " current";
                isActive = false;
            }
            container.innerHTML += `
                <div class="${cssClass}">
                    <div class="timeline-title">${step}</div>
                    <div class="timeline-date">${isActive ? 'Completed' : 'Pending'}</div>
                </div>`;
        });
    }
</script>

</body>
</html>
