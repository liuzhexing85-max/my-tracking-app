<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Logistics - Professional Tracking</title>
    
    <!-- APP ICON -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/411/411763.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/411/411763.png">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #0d2c56;
            --accent-color: #fca311;
            --bg-color: #f3f5f9;
        }

        body { background-color: var(--bg-color); font-family: 'Poppins', sans-serif; color: #333; }

        /* NAVBAR */
        .navbar { background-color: var(--primary-color) !important; padding: 15px 0; }
        .navbar-brand { font-weight: 700; letter-spacing: 1px; font-size: 1.5rem; }

        /* CARDS */
        .custom-card {
            background: #fff; border-radius: 16px; border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px;
        }

        /* MANAGE LIST CARD STYLE (Mobile Friendly) */
        .manage-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        .manage-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .manage-value { font-size: 1rem; font-weight: 600; color: #333; margin-bottom: 8px; }

        /* INPUTS */
        .custom-input {
            background-color: #f8f9fa; border: 2px solid #eee; border-radius: 12px;
            padding: 12px; margin-bottom: 15px;
        }
        .btn-track {
            background-color: var(--accent-color); color: #fff; font-weight: bold;
            border-radius: 12px; padding: 15px; width: 100%; border: none;
        }

        /* TIMELINE */
        .timeline-container { margin: 30px 0; padding-left: 20px; }
        .timeline-step { position: relative; padding-bottom: 30px; padding-left: 30px; border-left: 3px solid #e0e0e0; }
        .timeline-step:last-child { border-left: transparent; }
        .timeline-step::before {
            content: ''; position: absolute; left: -11px; top: 0; width: 20px; height: 20px;
            border-radius: 50%; background: #fff; border: 4px solid #e0e0e0;
        }
        .timeline-step.active { border-left-color: #28a745; }
        .timeline-step.active::before { border-color: #28a745; background: #28a745; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="bi bi-truck-flatbed"></i> GLOBAL LOGISTICS</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" onclick="showPage('home')">TRACK</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('adminLogin')">ADMIN</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4 mb-5">

    <!-- 1. USER TRACKING PAGE -->
    <div id="homePage">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="custom-card text-center">
                    <h3 class="fw-bold mb-4" style="color: var(--primary-color);">Track Package</h3>
                    
                    <input type="text" id="trackInput" class="form-control custom-input" placeholder="Tracking Number (e.g. DS-123456)">
                    <input type="text" id="verifyInput" class="form-control custom-input" placeholder="Verify Code (e.g. MKL34)">
                    
                    <button class="btn-track shadow-sm" onclick="trackShipment()">TRACK NOW</button>

                    <div id="errorMsg" class="alert alert-danger hidden mt-3 border-0">
                        <i class="bi bi-exclamation-circle-fill"></i> <span id="errorText">Not Found!</span>
                    </div>
                    <div id="loadingSpinner" class="hidden mt-3"><div class="spinner-border text-primary"></div></div>
                </div>

                <!-- RESULT CARD -->
                <div id="trackingResult" class="custom-card hidden">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="text-muted small">Tracking Number</div>
                            <h4 class="fw-bold text-primary" id="resTrackNo">---</h4>
                        </div>
                        <span id="resStatusBadge" class="badge bg-success rounded-pill px-3 py-2">---</span>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="manage-label">Sender</div>
                            <div class="fw-bold" id="resSender">---</div>
                            <div class="small text-muted" id="resFromCountry">---</div>
                        </div>
                        <div class="col-6">
                            <div class="manage-label">Receiver</div>
                            <div class="fw-bold" id="resClient">---</div>
                            <div class="small text-muted" id="resToCountry">---</div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="fw-bold text-secondary">History</h6>
                    <div class="timeline-container" id="timelineContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ADMIN LOGIN -->
    <div id="adminLoginPage" class="hidden">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="custom-card text-center">
                    <h4 class="fw-bold mb-4">Admin Login</h4>
                    <input type="text" id="adminUser" class="form-control custom-input" placeholder="Username">
                    <input type="password" id="adminPass" class="form-control custom-input" placeholder="Password">
                    <button class="btn btn-primary w-100 rounded-pill py-2" onclick="login()">LOGIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ADMIN DASHBOARD -->
    <div id="adminDashboard" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary">Dashboard</h4>
            <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="logout()">Logout</button>
        </div>

        <!-- TABS -->
        <ul class="nav nav-pills nav-fill mb-3 bg-white p-2 rounded shadow-sm">
            <li class="nav-item"><button class="nav-link active fw-bold" id="create-tab" data-bs-toggle="tab" data-bs-target="#create">Create</button></li>
            <li class="nav-item"><button class="nav-link fw-bold" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage">Manage List</button></li>
        </ul>

        <div class="tab-content">
            <!-- CREATE TAB -->
            <div class="tab-pane fade show active" id="create">
                <div class="custom-card">
                    <h6 class="text-primary fw-bold mb-3">SENDER</h6>
                    <input type="text" id="senderName" class="form-control custom-input" placeholder="Sender Name">
                    <input type="text" id="senderLoc" class="form-control custom-input" placeholder="Sender Location">
                    <select id="sendFromCountry" class="form-select custom-input">
                        <option value="" disabled selected>Select Origin</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Singapore">Singapore</option>
                        <option value="Thailand">Thailand</option>
                    </select>

                    <h6 class="text-success fw-bold mb-3 mt-4">CLIENT</h6>
                    <input type="text" id="clientName" class="form-control custom-input" placeholder="Client Name">
                    <input type="text" id="clientPhone" class="form-control custom-input" placeholder="Phone Number">
                    <input type="text" id="clientLoc" class="form-control custom-input" placeholder="Client Location">
                    <select id="sendToCountry" class="form-select custom-input">
                        <option value="" disabled selected>Select Destination</option>
                        <optgroup label="Popular">
                            <option value="Myanmar">Myanmar</option>
                            <option value="Thailand">Thailand</option>
                            <option value="Singapore">Singapore</option>
                            <option value="Vietnam">Vietnam</option>
                        </optgroup>
                        <optgroup label="Others">
                            <option value="USA">USA</option>
                            <option value="Japan">Japan</option>
                            <option value="Korea">Korea</option>
                            <option value="Australia">Australia</option>
                            <option value="Austria">Austria</option>
                            <option value="UK">UK</option>
                        </optgroup>
                    </select>

                    <button class="btn btn-primary w-100 btn-lg rounded-pill mt-3" onclick="createShipmentFirestore()">GENERATE & SAVE</button>
                </div>
            </div>

            <!-- MANAGE TAB (UPDATED DESIGN) -->
            <div class="tab-pane fade" id="manage">
                <div id="shipmentListContainer">
                    <!-- JS will load cards here -->
                    <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- QR MODAL -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 p-3">
            <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <h4 class="fw-bold text-success">Success!</h4>
                <div class="bg-light p-3 rounded mt-2 mb-3">
                    <div class="small text-muted">Tracking No</div>
                    <div class="fs-4 fw-bold text-primary" id="modalTrackNo">---</div>
                    <hr>
                    <div class="small text-muted">Verify Code</div>
                    <div class="fs-3 fw-bold text-danger font-monospace" id="modalVerifyCode">---</div>
                </div>
                <div id="qrResultArea" class="hidden mt-3">
                    <img id="generatedQrImg" src="" class="img-fluid border p-2 rounded" style="width: 180px;">
                </div>
                <button class="btn btn-primary mt-3 px-4" onclick="showQrInModal()">Show QR</button>
            </div>
        </div>
    </div>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // -------------------------------------------------------------------
    // --- FIREBASE CONFIG (PASTE YOUR CONFIG HERE) ---
    // -------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCDTIcr5F3D7xA0DR6TLnN3inEtcXJNSEQ",
      authDomain: "drop-shopping-99a05.firebaseapp.com",
      databaseURL: "https://drop-shopping-99a05-default-rtdb.firebaseio.com",
      projectId: "drop-shopping-99a05",
      storageBucket: "drop-shopping-99a05.firebasestorage.app",
      messagingSenderId: "838665485285",
      appId: "1:838665485285:web:2d131abfc7d556872e8d0c",
      measurementId: "G-FL3EFJGSLT"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const STATUS_STEPS = ["Arrived at custom", "In transit", "Arrived", "Out for delivery", "Delivered"];
    let latestTrackNo = ""; 

    // --- NAVIGATION ---
    function showPage(pageId) {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('adminLoginPage').classList.add('hidden');
        document.getElementById('adminDashboard').classList.add('hidden');
        
        const navBar = document.getElementById('navbarNav');
        if(navBar.classList.contains('show')) new bootstrap.Collapse(navBar).hide();

        if(pageId === 'home') document.getElementById('homePage').classList.remove('hidden');
        if(pageId === 'adminLogin') document.getElementById('adminLoginPage').classList.remove('hidden');
        if(pageId === 'dashboard') {
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadRealtimeShipments();
        }
    }

    // --- ADMIN LOGIC ---
    function login() {
        const u = document.getElementById('adminUser').value;
        const p = document.getElementById('adminPass').value;
        if(u === "lacus" && btoa(p) === "bGFjdXMwMDAw") {
            showPage('dashboard');
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
        } else {
            alert("Access Denied");
        }
    }
    function logout() { showPage('home'); }

    function generateVerifyCode() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; 
        let result = "";
        for (let i = 0; i < 5; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
        return result;
    }

    // --- FIREBASE: CREATE ---
    function createShipmentFirestore() {
        const sName = document.getElementById('senderName').value;
        const sLoc = document.getElementById('senderLoc').value;
        const sCountry = document.getElementById('sendFromCountry').value;
        const cName = document.getElementById('clientName').value;
        const cPhone = document.getElementById('clientPhone').value;
        const cLoc = document.getElementById('clientLoc').value;
        const cCountry = document.getElementById('sendToCountry').value;

        if(!sName || !cName) { alert("Please fill details."); return; }

        const trackNo = "DS-" + Math.floor(100000 + Math.random() * 900000);
        const verifyCode = generateVerifyCode();
        latestTrackNo = trackNo;

        db.collection("shipments").add({
            track_id: trackNo, verify_code: verifyCode,
            sender: sName, senderLoc: sLoc, fromCountry: sCountry,
            client: cName, clientPhone: cPhone, clientLoc: cLoc, toCountry: cCountry,
            status: "Arrived at custom", createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.querySelectorAll('#create input').forEach(input => input.value = '');
            document.getElementById('modalTrackNo').innerText = trackNo;
            document.getElementById('modalVerifyCode').innerText = verifyCode;
            document.getElementById('qrResultArea').classList.add('hidden');
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        }).catch(err => alert("Error: " + err.message));
    }

    function showQrInModal() {
        document.getElementById('generatedQrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${latestTrackNo}`;
        document.getElementById('qrResultArea').classList.remove('hidden');
    }

    // --- FIREBASE: MANAGE LIST (UPDATED WITH ALERT) ---
    function loadRealtimeShipments() {
        db.collection("shipments").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            const container = document.getElementById('shipmentListContainer');
            container.innerHTML = '';
            
            if(snapshot.empty) { container.innerHTML = '<div class="text-center text-muted py-5">No shipments found.</div>'; return; }

            snapshot.forEach((doc) => {
                const item = doc.data();
                
                let statusOptions = '';
                STATUS_STEPS.forEach(step => {
                    const selected = item.status === step ? 'selected' : '';
                    statusOptions += `<option value="${step}" ${selected}>${step}</option>`;
                });

                // CARD LAYOUT FOR MOBILE
                const card = `
                    <div class="manage-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="manage-label">Tracking ID</div>
                                <div class="manage-value text-primary">${item.track_id}</div>
                            </div>
                            <div class="text-end">
                                <div class="manage-label">Verify Code</div>
                                <div class="badge bg-light text-danger border">${item.verify_code}</div>
                            </div>
                        </div>
                        
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="manage-label">Client</div>
                                <div class="manage-value">${item.client} <span class="text-muted fw-normal">(${item.clientPhone})</span></div>
                            </div>
                        </div>

                        <div class="mt-2">
                            <div class="manage-label">Update Status</div>
                            <select onchange="updateStatus('${doc.id}', this.value)" class="form-select mt-1 bg-light fw-bold border-secondary">
                                ${statusOptions}
                            </select>
                        </div>

                        <div class="mt-3 text-end border-top pt-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteShipment('${doc.id}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        });
    }

    // --- UPDATE STATUS WITH ALERT ---
    function updateStatus(docId, val) { 
        db.collection("shipments").doc(docId).update({ status: val })
        .then(() => {
            alert("Status Updated Successfully!"); // Confirmation Alert
        })
        .catch((error) => {
            alert("Error updating status: " + error);
        });
    }

    function deleteShipment(docId) { if(confirm("Delete?")) db.collection("shipments").doc(docId).delete(); }

    // --- USER TRACKING ---
    function trackShipment() {
        const inputId = document.getElementById('trackInput').value.trim();
        const inputCode = document.getElementById('verifyInput').value.trim();
        const resDiv = document.getElementById('trackingResult');
        const errDiv = document.getElementById('errorMsg');
        const errText = document.getElementById('errorText');
        const load = document.getElementById('loadingSpinner');

        resDiv.classList.add('hidden'); errDiv.classList.add('hidden');

        if(!inputId || !inputCode) {
            errText.innerText = "Enter Tracking Number & Code"; errDiv.classList.remove('hidden'); return;
        }
        
        load.classList.remove('hidden');

        db.collection("shipments").where("track_id", "==", inputId).get().then((snapshot) => {
            load.classList.add('hidden');
            if(snapshot.empty) { errText.innerText = "Tracking Number not found!"; errDiv.classList.remove('hidden'); return; }

            const data = snapshot.docs[0].data();
            if (data.verify_code.toUpperCase() === inputCode.toUpperCase()) {
                resDiv.classList.remove('hidden');
                document.getElementById('resTrackNo').innerText = data.track_id;
                document.getElementById('resStatusBadge').innerText = data.status;
                document.getElementById('resSender').innerText = data.sender;
                document.getElementById('resFromCountry').innerText = data.fromCountry;
                document.getElementById('resClient').innerText = data.client;
                document.getElementById('resToCountry').innerText = data.toCountry;
                renderTimeline(data.status);
            } else {
                errText.innerText = "Incorrect Verify Code!"; errDiv.classList.remove('hidden');
            }
        }).catch(err => {
            load.classList.add('hidden'); errText.innerText = "Connection Error"; errDiv.classList.remove('hidden');
        });
    }

    function renderTimeline(currentStatus) {
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';
        let isActive = true;
        STATUS_STEPS.forEach(step => {
            let cssClass = "timeline-step";
            if(isActive) cssClass += " active";
            if(step === currentStatus) { cssClass += " current"; isActive = false; }
            container.innerHTML += `<div class="${cssClass}"><div class="timeline-title">${step}</div></div>`;
        });
    }
</script>

</body>
</html>
